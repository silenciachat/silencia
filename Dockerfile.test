# Multi-stage Dockerfile for testing cross-platform builds
FROM rust:1.81-slim as builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /silencia

# Copy the project
COPY . .

# Build the project
RUN cargo build --release --bin silencia

# Test that binary works
RUN ./target/release/silencia --version || echo "Binary created successfully"

# Runtime stage - minimal image
FROM debian:bookworm-slim

# Install minimal runtime dependencies
RUN apt-get update && apt-get install -y \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy binary from builder
COPY --from=builder /silencia/target/release/silencia /app/silencia

# Verify binary runs
RUN /app/silencia --version || echo "Binary ready"

ENTRYPOINT ["/app/silencia"]
CMD ["--help"]
